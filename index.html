<!DOCTYPE html>
<html lang="en" class="w-screenh-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Gothic+Condensed+One&display=swap" rel="stylesheet">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <link href="./src/output.css" rel="stylesheet">
</head>
<body class="w-full bg-emerald-950 m-0 p-0 text-white flex flex-col items-start justify-start h-screen min-h-screen overflow-hidden">
    <div class="stations relative overflow-hidden py-2 flex flex-col gap-0 bg-emerald-900 rounded-br-3xl w-[calc(100%-1.5rem)] shadow-[0_0_200px_rgba(0,0,0,1)] z-2">
        <h2 class="special-gothic-condensed-one-regular text-xl text-white px-6 pt-3 flex flex-row items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-4 text-emerald-300">
              <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
            </svg>
            <span>YOUR STATIONS</span>
        </h2>
        <div class="bg-edge absolute pointer-events-none bottom-0 right-0 w-full h-full bg-cover bg-bottom-right blur-2xl z-1" style="background-image: url('bg-edge.png');">
            
        </div>
    
        <!-- Station Carousel -->
        <div class="carousel relative mb-1 overflow-x-auto flex w-full space-x-4 no-scrollbar px-6 py-6 gap-3 z-2" >

          <!-- Station 1: Liked -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-liked.png');">
              <span class="sr-only">Liked</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Liked Songs</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Your favorite tracks</h3>
          </div>
          <!-- Station 2: Oldies -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-oldies.png');">
              <span class="sr-only">Oldies</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Golden Oldies</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Classics from the 50s & 60s</h3>
          </div>
          <!-- Station 3: 70's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-70s.png');">
              <span class="sr-only">70's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Groovy 70s</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Hits from the seventies</h3>
          </div>
          <!-- Station 4: 80's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-80s.png');">
              <span class="sr-only">80's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Awesome 80s</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">The unforgettable eighties</h3>
          </div>
          <!-- Station 5: 90's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-90s.png');">
              <span class="sr-only">90's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">90s Throwback</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Biggest hits of the nineties</h3>
          </div>
          <!-- Station 6: 2k -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">2k</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Y2K Hits</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Pop from the 2000s</h3>
          </div>
          <!-- Station 7: New Music -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">New Music</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Fresh Finds</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Latest music releases</h3>
          </div>
          <!-- Station 8: Party Bangers -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">Party Bangers</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Party Bangers</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">High-energy anthems</h3>
          </div>
          <!-- Station 9: High School Jams -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">High School Jams</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">HS Rewind</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Your high school soundtrack</h3>
          </div>
          <!-- Station 10: Talk -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">Talk</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Talk & Podcasts</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">News, comedy & stories</h3>
          </div>
        </div>
        
    </div>

    <div class="now-playing-container relative z-2 mt-2">
        <h2 class="special-gothic-condensed-one-regular text-xl text-white px-6 pt-4 flex flex-row items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-4 text-emerald-300">
                <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 0 1 .298.599V16.303a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.403-4.909l2.311-.66a1.5 1.5 0 0 0 1.088-1.442V6.994l-9 2.572v9.737a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.402-4.909l2.31-.66a1.5 1.5 0 0 0 1.088-1.442V5.25a.75.75 0 0 1 .544-.721l10.5-3a.75.75 0 0 1 .658.122Z" clip-rule="evenodd" />
              </svg>
              

            <span>NOW PLAYING</span>
        </h2>

    <div class="now-playing w-full p-6 grid grid-cols-2 gap-6">
        <div class="aspect-square cover w-full h-full bg-cover bg-center" style="background-image: url('cover.png');">
        </div>
        <div class="track-meta w-full flex flex-col gap-0 justify-between">
            <div class="info">
            <h2 class="track flex flex-col gap-2r text-xl font-semibold">
                <span class="artist-name uppercase text-base text-emerald-300">Lil Nas X</span>
                <span class="track-title text-2xl line-clamp-2">Industry Baby (or a Longer Title Here)</span>
               
            </h2>
            <h4 class="album-title special-gothic-condensed-one-regular text-md text-emerald-600 leading-tight">Montero</h4>
            </div>
            <div class="time flex flex-row justify-between">
                <div class="time-elapsed">0:23</div>
                <div class="time-total">3:41</div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-emerald-200 rounded-full h-1 my-2">
              <div class="progress bg-emerald-600 h-1 rounded-full" style="width: 0%;"></div>
            </div>

            <div class="playback-time special-gothic-condensed-one-regular text-lg text-emerald-700 mt-auto flex flex-row items-center justify-between">
                <div class="time-current">0:00</div>
                <div class="time-total">3:41</div>
            </div>
        </div>
        
        
    </div>
    </div>



<script>
document.addEventListener('DOMContentLoaded', () => {
  const stations = document.querySelectorAll('.station');
  const activeRingClasses = ['ring-4', 'ring-pink-300', 'ring-offset-6', 'ring-offset-emerald-900'];

  function setActiveStation(targetStation) {
    if (!targetStation) return;

    // Remove active classes from all station images
    stations.forEach(station => {
      const imageDiv = station.children[0]; // Assuming image div is the first child
      if (imageDiv && imageDiv.classList) { // Check if it's an element and has classList
        imageDiv.classList.remove(...activeRingClasses);
      }
    });

    // Add active classes to the target station's image
    const targetImageDiv = targetStation.children[0]; // Assuming image div is the first child
    if (targetImageDiv && targetImageDiv.classList) { // Check if it's an element and has classList
      targetImageDiv.classList.add(...activeRingClasses);
    }
  }

  // Set initial active station
  if (stations.length > 0) {
    setActiveStation(stations[0]);
  }

  stations.forEach(station => {
    station.addEventListener('click', () => {
      setActiveStation(station);
      // Ensure the station scrolls into view.
      station.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    });
  });

  // Spotify Auth Button
  const connectSpotifyBtn = document.getElementById('connect-spotify-btn');
  const spotifyAuthOverlay = document.getElementById('spotify-auth-overlay');

  function parseHashParams() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return {
      accessToken: params.get('access_token'),
      refreshToken: params.get('refresh_token'),
      expiresIn: params.get('expires_in'),
      error: params.get('error'),
    };
  }

  // Global variables for Spotify player and device ID
  let spotifyPlayer = null;
  let spotifyDeviceId = null;
  let currentAccessToken = null; // Store the current access token globally for API calls

  function updateNowPlayingUI(track) {
    const coverArtEl = document.querySelector('.now-playing .cover');
    const trackTitleEl = document.querySelector('.now-playing .track-title');
    const artistNameEl = document.querySelector('.now-playing .artist-name');
    const albumNameEl = document.querySelector('.now-playing .album-title'); // Make sure you have an element with this class
    const timeCurrentEl = document.querySelector('.now-playing .time-current');
    const timeTotalEl = document.querySelector('.now-playing .time-total');

    if (!track) {
        if(coverArtEl) coverArtEl.style.backgroundImage = `url('./placeholder.jpg')`;
        if(trackTitleEl) trackTitleEl.textContent = '-';
        if(artistNameEl) artistNameEl.textContent = 'Nothing Playing';
        if(albumNameEl) albumNameEl.textContent = '-';
        if(timeCurrentEl) timeCurrentEl.textContent = '0:00';
        if(timeTotalEl) timeTotalEl.textContent = '0:00';
        return;
    }

    const albumArtUrl = track.album.images[0] ? track.album.images[0].url : './placeholder.jpg';
    const artists = track.artists.map(artist => artist.name).join(', ');
    const formatTime = (ms) => {
        const minutes = Math.floor(ms / 60000);
        const seconds = ((ms % 60000) / 1000).toFixed(0);
        return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
    };

    if (coverArtEl) coverArtEl.style.backgroundImage = `url('${albumArtUrl}')`;
    if (trackTitleEl) trackTitleEl.textContent = track.name;
    if (artistNameEl) artistNameEl.textContent = artists;
    if (albumNameEl) albumNameEl.textContent = track.album.name; 
    // Player state doesn't directly give current time for non-active device, rely on player_state_changed or an interval
    if (timeTotalEl) timeTotalEl.textContent = formatTime(track.duration_ms);
    // Current time will be updated by player_state_changed event more accurately
    if (timeCurrentEl) timeCurrentEl.textContent = '0:00'; // Initial

    // Update station title display if needed (you had a <p class="station"> element)
    const stationTitleDisplay = document.querySelector('.now-playing .station-name'); // Make sure you have this element
    if (stationTitleDisplay) stationTitleDisplay.textContent = "Now Playing"; // Or actual station if applicable
  }

  async function fetchWebApi(endpoint, method, body) {
    if (!currentAccessToken) {
        console.error('Access token is not available for API call');
        // Potentially trigger re-authentication or refresh token logic here
        return null;
    }
    const res = await fetch(`https://api.spotify.com/v1${endpoint}`,
    {
        headers: {
            'Authorization': `Bearer ${currentAccessToken}`,
            'Content-Type': 'application/json' // Added for POST/PUT if body is JSON
        },
        method,
        body: body ? JSON.stringify(body) : undefined
    });
    if (!res.ok) {
        console.error(`Spotify API Error (${res.status}) for ${method} ${endpoint}:`, await res.json().catch(() => ({})));
        if (res.status === 401) { // Token expired or invalid
            // Attempt to refresh token or re-authenticate
            console.error('Token expired or invalid. Implement refresh logic or re-auth.');
            // For now, show auth overlay
            if(spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_token_expires_at');
            localStorage.removeItem('spotify_refresh_token');
        }
        return null;
    }
    try {
        return await res.json();
    } catch (e) {
        // Handle cases where response might be empty (e.g., 204 No Content for player commands)
        if (res.status === 204) return { success: true }; 
        console.error('Error parsing Spotify API JSON response:', e);
        return null;
    }
  }

  async function playTrack(trackUri, deviceId) {
    if (!deviceId) {
        console.error('No device ID available to play track.');
        return;
    }
    const result = await fetchWebApi(`/me/player/play?device_id=${deviceId}`, 'PUT', {
        uris: [trackUri]
    });
    if (result) {
        console.log('Playback started for track:', trackUri);
    }
  }

  async function fetchAndPlayRandomLikedSong(deviceId) {
    console.log('Fetching liked songs...');
    // Get a few liked songs, pick one randomly
    const data = await fetchWebApi('/me/tracks?limit=20', 'GET'); 
    if (data && data.items && data.items.length > 0) {
        const randomIndex = Math.floor(Math.random() * data.items.length);
        const randomTrack = data.items[randomIndex].track;
        if (randomTrack && randomTrack.uri) {
            console.log('Playing random liked song:', randomTrack.name);
            playTrack(randomTrack.uri, deviceId);
        } else {
            console.error('Could not get a valid track URI from liked songs.');
            updateNowPlayingUI(null); // Clear UI if no track
        }
    } else {
        console.error('No liked songs found or error fetching them.');
        // Display a message to the user, e.g., in the now playing area
        const artistNameEl = document.querySelector('.now-playing .artist-name');
        if(artistNameEl) artistNameEl.textContent = 'No liked songs found.';
        updateNowPlayingUI(null); // Clear UI
    }
  }

  // This function will be called by the Spotify SDK when it's ready
  window.onSpotifyWebPlaybackSDKReady = () => {
    console.log('Spotify Web Playback SDK is ready.');
    // If we already have an access token (e.g., from page load/hash or localStorage),
    // and the player isn't already initialized, initialize it.
    if (currentAccessToken && !spotifyPlayer) {
      initializePlayerInternal(currentAccessToken);
    } else if (!currentAccessToken) {
        console.log('SDK ready, but access token not yet available.');
        // The handleAuth function will call initializePlayerInternal once token is available.
    }
  };

  // Renamed to avoid conflict and to be called internally once SDK is ready and token is available
  function initializePlayerInternal(accessToken) {
    if (spotifyPlayer) {
        console.log('Player already initialized.');
        return;
    }
    currentAccessToken = accessToken; // Ensure global token is set
    console.log('Initializing Spotify Web Playback SDK with token (internal):', accessToken);

    spotifyPlayer = new Spotify.Player({
        name: 'SuperFun Music Player',
        getOAuthToken: cb => { cb(currentAccessToken); }, // Use the globally stored token
        volume: 0.5
    });

    spotifyPlayer.addListener('ready', ({ device_id }) => {
        console.log('Spotify Player Ready with Device ID', device_id);
        spotifyDeviceId = device_id;
        fetchAndPlayRandomLikedSong(spotifyDeviceId);
    });

    spotifyPlayer.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
        spotifyDeviceId = null;
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('initialization_error', ({ message }) => {
        console.error('Failed to initialize Spotify player:', message);
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('authentication_error', ({ message }) => {
        console.error('Spotify player authentication error:', message);
        if(spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
        localStorage.removeItem('spotify_access_token');
        localStorage.removeItem('spotify_token_expires_at');
        localStorage.removeItem('spotify_refresh_token');
        currentAccessToken = null;
        spotifyPlayer = null; // Reset player
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('account_error', ({ message }) => {
        console.error('Spotify player account error (e.g., no Premium?):', message);
        const artistNameEl = document.querySelector('.now-playing .artist-name');
        if(artistNameEl) artistNameEl.textContent = 'Spotify Premium required for playback.';
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('playback_error', ({ message }) => {
        console.error('Spotify player playback error:', message);
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('player_state_changed', (state) => {
        if (!state) {
            console.warn('Player state changed to null.');
            updateNowPlayingUI(null);
            // Clear progress bar and time if state is null
            const progressEl = document.querySelector('.now-playing .progress');
            if(progressEl) progressEl.style.width = '0%';
            const timeCurrentEl = document.querySelector('.now-playing .time-current'); // Or your .time-elapsed
            if(timeCurrentEl) timeCurrentEl.textContent = '0:00';
            const timeTotalEl = document.querySelector('.now-playing .time-total');
            if(timeTotalEl) timeTotalEl.textContent = '0:00';
            return;
        }
        console.log('Player state changed:', state);
        const currentTrack = state.track_window.current_track;
        updateNowPlayingUI(currentTrack); // This will update cover, title, artist, album, and initial total time

        const formatTime = (ms) => {
            const minutes = Math.floor(ms / 60000);
            const seconds = ((ms % 60000) / 1000).toFixed(0);
            return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
        };

        // Update current time display (e.g., .time-elapsed or .time-current)
        const timeCurrentEl = document.querySelector('.now-playing .time-current'); 
        if(timeCurrentEl) timeCurrentEl.textContent = formatTime(state.position);

        // Update total time display (if not already set by updateNowPlayingUI or if it can change)
        const timeTotalEl = document.querySelector('.now-playing .time-total');
        if(timeTotalEl && currentTrack) timeTotalEl.textContent = formatTime(currentTrack.duration_ms);
        
        // Update progress bar width
        const progressEl = document.querySelector('.now-playing .progress');
        if (progressEl && currentTrack && currentTrack.duration_ms > 0) {
            const progressPercent = (state.position / currentTrack.duration_ms) * 100;
            progressEl.style.width = `${progressPercent}%`;
        } else if (progressEl) {
            progressEl.style.width = '0%';
        }

        // Handle play/pause button state for your big play button (if needed)
        const playButtonSvg = document.querySelector('#main-play-button svg path'); // More specific selector for the path
        // This is a simple example; you might need to swap SVGs or classes for a visual change
        if (playButtonSvg) {
            // Assuming your play SVG path is the default state
            // You would need a different path for a pause icon to swap to
            // For now, this won't visually change your current play button to a pause icon
            // console.log(state.paused ? "Should show Play icon" : "Should show Pause icon");
        }
    });

    spotifyPlayer.connect().then(success => {
        if (success) {
            console.log('The Web Playback SDK successfully connected to Spotify!');
        } else {
            console.error('The Web Playback SDK failed to connect to Spotify.');
        }
    });
  }

  // Modify handleAuth to store token and call initializePlayerInternal if SDK is ready
  function handleAuth() {
    const { accessToken, refreshToken, expiresIn, error } = parseHashParams();
    const authOverlayTitle = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('h2') : null;
    const authOverlayButton = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('button') : null;
    const authOverlayMessage = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('p') : null;

    if (error && authOverlayTitle && authOverlayButton && authOverlayMessage) {
      console.error('Spotify Auth Error:', error);
      authOverlayTitle.textContent = 'Authentication Failed';
      authOverlayButton.textContent = 'TRY AGAIN';
      authOverlayMessage.textContent = `Error: ${error}. Please ensure you have granted permissions and try again.`;
      window.location.hash = '';
      if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex'; 
      return;
    }

    if (accessToken) {
      localStorage.setItem('spotify_access_token', accessToken);
      localStorage.setItem('spotify_token_expires_at', Date.now() + parseInt(expiresIn, 10) * 1000);
      if (refreshToken) {
        localStorage.setItem('spotify_refresh_token', refreshToken);
      }
      console.log('Spotify Access Token Stored from Hash.');
      currentAccessToken = accessToken; // Set global token
      if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'none';
      window.location.hash = '';
      // Check if SDK is ready (Spotify object exists) and then initialize player
      if (typeof Spotify !== 'undefined' && !spotifyPlayer) {
        initializePlayerInternal(accessToken);
      } else if (spotifyPlayer) {
        console.log('Player already initialized or SDK not ready yet for new token.');
      }
      return;
    }

    const storedAccessToken = localStorage.getItem('spotify_access_token');
    const tokenExpiresAt = localStorage.getItem('spotify_token_expires_at');

    if (storedAccessToken && tokenExpiresAt && Date.now() < parseInt(tokenExpiresAt, 10)) {
      console.log('Found valid stored Spotify Access Token.');
      currentAccessToken = storedAccessToken; // Set global token
      if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'none';
      // Check if SDK is ready and then initialize player
      if (typeof Spotify !== 'undefined' && !spotifyPlayer) {
        initializePlayerInternal(storedAccessToken);
      } else if (spotifyPlayer) {
        console.log('Player already initialized or SDK not ready yet for stored token.');
      }
    } else {
      console.log('No valid token found. Displaying auth overlay.');
      if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
      localStorage.removeItem('spotify_access_token');
      localStorage.removeItem('spotify_token_expires_at');
      localStorage.removeItem('spotify_refresh_token');
      currentAccessToken = null;
      if(spotifyPlayer) { spotifyPlayer.disconnect(); spotifyPlayer = null; } // Disconnect and clear player if token invalid
    }
  }

  if (connectSpotifyBtn) {
    connectSpotifyBtn.addEventListener('click', () => {
      window.location.href = '/.netlify/functions/spotify-auth-login';
    });
  }

  // Handle authentication on page load
  handleAuth();

});
</script>

<!-- Global Playback Scrubber -->
<div class="fixed bottom-0 top-0 left-0 w-full opacity-10 pointer-events-none z-1">
  <div class="progressh-full bg-white transition-all" style="width: 20%;"></div>
</div>

<!-- Spotify Auth Overlay -->
<div id="spotify-auth-overlay" class="fixed inset-0 bg-emerald-950 bg-opacity-90 flex flex-col items-center justify-center z-50">
  <h2 class="special-gothic-condensed-one-regular text-4xl text-white mb-8">Connect to Spotify</h2>
  <button id="connect-spotify-btn" class="special-gothic-condensed-one-regular bg-green-500 hover:bg-green-400 text-white text-2xl py-4 px-8 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-green-300 focus:ring-opacity-50 transition duration-150 ease-in-out">
    TAP TO CONNECT SPOTIFY
  </button>
  <p class="text-emerald-300 text-sm mt-6 max-w-xs text-center">
    This app requires access to your Spotify account to play music and manage playback.
  </p>
</div>
</body>
</html> 