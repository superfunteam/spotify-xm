<!DOCTYPE html>
<html lang="en" class="w-screenh-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Gothic+Condensed+One&display=swap" rel="stylesheet">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <link href="./src/output.css" rel="stylesheet">
</head>
<body class="w-full bg-emerald-950 m-0 p-0 text-white flex flex-col items-start justify-start h-screen min-h-screen overflow-hidden">
    <div class="stations relative overflow-hidden py-2 flex flex-col gap-0 bg-emerald-900 rounded-br-3xl w-[calc(100%-1.5rem)] shadow-[0_0_200px_rgba(0,0,0,1)] z-2">
        <h2 class="special-gothic-condensed-one-regular text-xl text-white px-6 pt-3 flex flex-row items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-4 text-emerald-300">
              <path d="M18.375 2.25c-1.035 0-1.875.84-1.875 1.875v15.75c0 1.035.84 1.875 1.875 1.875h.75c1.035 0 1.875-.84 1.875-1.875V4.125c0-1.036-.84-1.875-1.875-1.875h-.75ZM9.75 8.625c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-.75a1.875 1.875 0 0 1-1.875-1.875V8.625ZM3 13.125c0-1.036.84-1.875 1.875-1.875h.75c1.036 0 1.875.84 1.875 1.875v6.75c0 1.035-.84 1.875-1.875 1.875h-.75A1.875 1.875 0 0 1 3 19.875v-6.75Z" />
            </svg>
            <span>YOUR STATIONS</span>
        </h2>
        <div class="bg-edge absolute pointer-events-none bottom-0 right-0 w-full h-full bg-cover bg-bottom-right blur-2xl z-1" style="background-image: url('bg-edge.png');">
            
        </div>
    
        <!-- Station Carousel -->
        <div class="carousel relative mb-1 overflow-x-auto flex w-full space-x-4 no-scrollbar px-6 py-6 gap-3 z-2" >

          <!-- Station 1: Liked -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-liked.png');">
              <span class="sr-only">Liked</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Liked Songs</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Your favorite tracks</h3>
          </div>
          <!-- Station 2: Oldies -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-oldies.png');">
              <span class="sr-only">Oldies</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Golden Oldies</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Classics from the 50s & 60s</h3>
          </div>
          <!-- Station 3: 70's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-70s.png');">
              <span class="sr-only">70's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Groovy 70s</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Hits from the seventies</h3>
          </div>
          <!-- Station 4: 80's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-80s.png');">
              <span class="sr-only">80's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Awesome 80s</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">The unforgettable eighties</h3>
          </div>
          <!-- Station 5: 90's -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('stations/station-90s.png');">
              <span class="sr-only">90's</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">90s Throwback</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Biggest hits of the nineties</h3>
          </div>
          <!-- Station 6: 2k -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">2k</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Y2K Hits</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Pop from the 2000s</h3>
          </div>
          <!-- Station 7: New Music -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">New Music</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Fresh Finds</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Latest music releases</h3>
          </div>
          <!-- Station 8: Party Bangers -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">Party Bangers</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Party Bangers</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">High-energy anthems</h3>
          </div>
          <!-- Station 9: High School Jams -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">High School Jams</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">HS Rewind</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">Your high school soundtrack</h3>
          </div>
          <!-- Station 10: Talk -->
          <div class="station shrink-0 flex flex-col items-center space-y-0 w-1/3 rounded-lg">
            <div class="cover aspect-[9/14] w-full mb-3 rounded-lg shadow-md bg-cover bg-center" style="background-image: url('./placeholder.jpg');">
              <span class="sr-only">Talk</span>
            </div>
            <h2 class="text-sm text-white font-semibold mt-1 truncate w-full text-left">Talk & Podcasts</h2>
            <h3 class="text-xs text-emerald-300 truncate w-full text-left">News, comedy & stories</h3>
          </div>
        </div>
        
    </div>

    <div class="now-playing-container w-full relative z-2 mt-2">
        <h2 class="special-gothic-condensed-one-regular text-xl text-white px-6 pt-4 flex flex-row items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-4 text-emerald-300">
                <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 0 1 .298.599V16.303a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.403-4.909l2.311-.66a1.5 1.5 0 0 0 1.088-1.442V6.994l-9 2.572v9.737a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.402-4.909l2.31-.66a1.5 1.5 0 0 0 1.088-1.442V5.25a.75.75 0 0 1 .544-.721l10.5-3a.75.75 0 0 1 .658.122Z" clip-rule="evenodd" />
              </svg>
              

            <span>NOW PLAYING</span>
        </h2>

    <div class="now-playing w-full p-6 grid grid-cols-2 gap-6">
        <div class="aspect-square cover w-full h-full bg-cover bg-center" style="background-image: url('cover.png');">
        </div>
        <div class="track-meta w-full flex flex-col gap-0 justify-between">
            <div class="info">
            <h2 class="track flex flex-col gap-2r text-xl font-semibold">
                <span class="artist-name uppercase text-base text-emerald-300">Lil Nas X</span>
                <span class="track-title text-2xl line-clamp-2">Industry Baby (or a Longer Title Here)</span>
               
            </h2>
            <p class="album-title text-emerald-300 opacity-50">Montero</p>
            </div>
            <div class="time flex flex-row justify-between">
                <div class="time-elapsed">0:23</div>
                <div class="time-total">3:41</div>
            </div>
        </div>
        
        
    </div>
    </div>



<script>
document.addEventListener('DOMContentLoaded', () => {
  const stations = document.querySelectorAll('.station');
  const activeRingClasses = ['ring-4', 'ring-pink-300', 'ring-offset-6', 'ring-offset-emerald-900'];

  function setActiveStation(targetStation) {
    if (!targetStation) return;

    // Remove active classes from all station images
    stations.forEach(station => {
      const imageDiv = station.children[0]; // Assuming image div is the first child
      if (imageDiv && imageDiv.classList) { // Check if it's an element and has classList
        imageDiv.classList.remove(...activeRingClasses);
      }
    });

    // Add active classes to the target station's image
    const targetImageDiv = targetStation.children[0]; // Assuming image div is the first child
    if (targetImageDiv && targetImageDiv.classList) { // Check if it's an element and has classList
      targetImageDiv.classList.add(...activeRingClasses);
    }
  }

  // Set initial active station
  if (stations.length > 0) {
    setActiveStation(stations[0]);
  }

  stations.forEach(station => {
    station.addEventListener('click', () => {
      setActiveStation(station);
      // Ensure the station scrolls into view.
      station.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    });
  });

  // Spotify Auth Button
  const connectSpotifyBtn = document.getElementById('connect-spotify-btn');
  const spotifyAuthOverlay = document.getElementById('spotify-auth-overlay');

  function parseHashParams() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return {
      accessToken: params.get('access_token'),
      refreshToken: params.get('refresh_token'),
      expiresIn: params.get('expires_in'),
      error: params.get('error'),
    };
  }

  // Global variables for Spotify player and device ID
  let spotifyPlayer = null;
  let spotifyDeviceId = null;
  let currentAccessToken = null;
  let deviceReadyTimestamp = null;
  let playbackAttempts = 0;

  function updateNowPlayingUI(track) {
    const coverArtEl = document.querySelector('.now-playing .cover');
    const trackTitleEl = document.querySelector('.now-playing .track-title');
    const artistNameEl = document.querySelector('.now-playing .artist-name');
    const albumNameEl = document.querySelector('.now-playing .album-title');
    const timeCurrentEl = document.querySelector('.now-playing .time-elapsed');
    const timeTotalEl = document.querySelector('.now-playing .time-total');

    if (!track) {
        if(coverArtEl) coverArtEl.style.backgroundImage = `url('./placeholder.jpg')`;
        if(trackTitleEl) trackTitleEl.textContent = '-';
        if(artistNameEl) artistNameEl.textContent = 'Nothing Playing';
        if(albumNameEl) albumNameEl.textContent = '-';
        if(timeCurrentEl) timeCurrentEl.textContent = '0:00';
        if(timeTotalEl) timeTotalEl.textContent = '0:00';
        return;
    }

    const albumArtUrl = track.album.images[0] ? track.album.images[0].url : './placeholder.jpg';
    const artists = track.artists.map(artist => artist.name).join(', ');
    const formatTime = (ms) => {
        const minutes = Math.floor(ms / 60000);
        const seconds = ((ms % 60000) / 1000).toFixed(0);
        return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
    };

    if (coverArtEl) coverArtEl.style.backgroundImage = `url('${albumArtUrl}')`;
    if (trackTitleEl) trackTitleEl.textContent = track.name;
    if (artistNameEl) artistNameEl.textContent = artists;
    if (albumNameEl) albumNameEl.textContent = track.album.name; 
    if (timeTotalEl) timeTotalEl.textContent = formatTime(track.duration_ms);
    if (timeCurrentEl) timeCurrentEl.textContent = '0:00';
  }

  async function fetchWebApi(endpoint, method, body) {
    if (!currentAccessToken) {
        console.error('Access token is not available for API call');
        return null;
    }
    
    try {
        const res = await fetch(`https://api.spotify.com/v1${endpoint}`, {
            headers: {
                'Authorization': `Bearer ${currentAccessToken}`,
                'Content-Type': 'application/json'
            },
            method,
            body: body ? JSON.stringify(body) : undefined
        });
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error(`Spotify API Error (${res.status}) for ${method} ${endpoint}:`, errorText);
            if (res.status === 401) {
                console.error('Token expired or invalid.');
                if(spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_token_expires_at');
                localStorage.removeItem('spotify_refresh_token');
            }
            return null;
        }
        
        if (res.status === 204) {
            return { success: true };
        }
        
        const responseText = await res.text();
        if (!responseText) {
            return { success: true };
        }
        
        try {
            return JSON.parse(responseText);
        } catch (parseError) {
            console.error('Failed to parse JSON response:', responseText.substring(0, 100));
            return null;
        }
    } catch (error) {
        console.error('Network error in fetchWebApi:', error);
        return null;
    }
  }

  async function waitForDeviceInSpotifyList(deviceId, maxWaitTime = 30000) {
    console.log(`Waiting for device ${deviceId} to appear in Spotify's device list...`);
    const startTime = Date.now();
    
    while (Date.now() - startTime < maxWaitTime) {
      try {
        const devices = await fetchWebApi('/me/player/devices', 'GET');
        if (devices && devices.devices) {
          const ourDevice = devices.devices.find(device => device.id === deviceId);
          if (ourDevice) {
            console.log('Device found in Spotify device list:', ourDevice);
            return true;
          }
        }
        
        console.log('Device not yet in list, waiting 2 seconds...');
        await new Promise(resolve => setTimeout(resolve, 2000));
      } catch (error) {
        console.error('Error checking device list:', error);
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
    
    console.error(`Device ${deviceId} never appeared in Spotify's device list`);
    return false;
  }

  async function ensureDeviceIsActiveAndReady(deviceId, maxRetries = 5) {
    console.log(`Ensuring device ${deviceId} is active and ready...`);
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      console.log(`Device activation attempt ${attempt}/${maxRetries}`);
      
      // Check if device exists and is active
      const devices = await fetchWebApi('/me/player/devices', 'GET');
      if (devices && devices.devices) {
        const ourDevice = devices.devices.find(device => device.id === deviceId);
        if (ourDevice && ourDevice.is_active) {
          console.log('Device is active and ready!');
          return true;
        }
        
        if (ourDevice) {
          console.log('Device exists but not active, transferring playback...');
          // Try to activate it
          const transferResult = await fetchWebApi('/me/player', 'PUT', {
            device_ids: [deviceId],
            play: false
          });
          
          if (transferResult !== null) {
            // Wait for activation to complete
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Check again
            const newDevices = await fetchWebApi('/me/player/devices', 'GET');
            if (newDevices && newDevices.devices) {
              const updatedDevice = newDevices.devices.find(device => device.id === deviceId);
              if (updatedDevice && updatedDevice.is_active) {
                console.log(`Device activated successfully on attempt ${attempt}`);
                return true;
              }
            }
          }
        } else {
          console.log('Device not found in device list, waiting...');
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
      }
      
      if (attempt < maxRetries) {
        console.log(`Device activation attempt ${attempt} failed, retrying...`);
        await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
      }
    }
    
    console.error(`Failed to activate device after ${maxRetries} attempts`);
    return false;
  }

  async function playTrackRobust(trackUri, deviceId) {
    console.log(`Playing track ${trackUri} on device ${deviceId}`);
    
    try {
      // Use the Web API play endpoint instead of SDK
      const result = await fetchWebApi(`/me/player/play?device_id=${deviceId}`, 'PUT', {
        uris: [trackUri],
        position_ms: 0
      });
      
      if (result !== null) {
        console.log('Track play command sent successfully');
        
        // Wait a moment for playback to start
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Verify playback started
        const playbackState = await fetchWebApi('/me/player', 'GET');
        if (playbackState && playbackState.is_playing) {
          console.log('Playback confirmed as active');
          return true;
        } else if (playbackState && !playbackState.is_playing) {
          console.log('Track loaded but paused, attempting to resume...');
          const resumeResult = await fetchWebApi('/me/player/play', 'PUT');
          if (resumeResult !== null) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const finalState = await fetchWebApi('/me/player', 'GET');
            return finalState && finalState.is_playing;
          }
        }
      }
      
      return false;
    } catch (error) {
      console.error('Error in playTrackRobust:', error);
      return false;
    }
  }

  async function fetchAndPlayRandomLikedSong(deviceId) {
    console.log('Fetching liked songs...');
    playbackAttempts++;
    console.log(`Playback attempt #${playbackAttempts}`);
    
    const data = await fetchWebApi('/me/tracks?limit=50', 'GET'); 
    if (data && data.items && data.items.length > 0) {
        const randomIndex = Math.floor(Math.random() * data.items.length);
        const randomTrack = data.items[randomIndex].track;
        if (randomTrack && randomTrack.uri) {
            console.log('Selected random liked song:', randomTrack.name, 'URI:', randomTrack.uri);
            
            // Ensure device is ready
            const deviceReady = await ensureDeviceIsActiveAndReady(deviceId);
            if (!deviceReady) {
              console.error('Device not ready for playback');
              return false;
            }
            
            return await playTrackRobust(randomTrack.uri, deviceId);
        } else {
            console.error('Could not get a valid track URI from liked songs.');
            updateNowPlayingUI(null);
        }
    } else {
        console.error('No liked songs found or error fetching them.');
        const artistNameEl = document.querySelector('.now-playing .artist-name');
        if(artistNameEl) artistNameEl.textContent = 'No liked songs found.';
        updateNowPlayingUI(null);
    }
    return false;
  }

  let sdkReady = false;

  window.onSpotifyWebPlaybackSDKReady = () => {
    console.log('Spotify Web Playback SDK is ready.');
    sdkReady = true;
    if (currentAccessToken && !spotifyPlayer) {
        initializePlayerInternal(currentAccessToken);
    }
  };

  function initializePlayerInternal(accessToken) {
    if (spotifyPlayer) {
        console.log('Player instance exists. Disconnecting old one first.');
        spotifyPlayer.disconnect(); 
        spotifyPlayer = null;
        spotifyDeviceId = null;
        deviceReadyTimestamp = null;
        playbackAttempts = 0;
    }
    
    currentAccessToken = accessToken; 
    console.log('Initializing Spotify Web Playback SDK instance');

    spotifyPlayer = new Spotify.Player({
        name: 'SuperFun Music Player',
        getOAuthToken: cb => { 
            if (!currentAccessToken) {
                console.warn('getOAuthToken: currentAccessToken is null. Checking localStorage.');
                const storedToken = localStorage.getItem('spotify_access_token');
                const expiresAt = localStorage.getItem('spotify_token_expires_at');
                if (storedToken && expiresAt && Date.now() < parseInt(expiresAt, 10)) {
                    currentAccessToken = storedToken;
                    console.log('getOAuthToken: Restored token from localStorage.');
                } else {
                    console.error('getOAuthToken: No valid token. Forcing re-auth.');
                    if(spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
                    localStorage.removeItem('spotify_access_token');
                    localStorage.removeItem('spotify_token_expires_at');
                    localStorage.removeItem('spotify_refresh_token');
                    cb(null); 
                    return;
                }
            }
            cb(currentAccessToken); 
        },
        volume: 0.5
    });

    spotifyPlayer.addListener('ready', async ({ device_id }) => {
        console.log('Spotify Player Ready with Device ID:', device_id);
        spotifyDeviceId = device_id;
        deviceReadyTimestamp = Date.now();
        
        try {
          // Wait for device to appear in Spotify's backend
          console.log('Waiting for device to be registered with Spotify backend...');
          const deviceRegistered = await waitForDeviceInSpotifyList(device_id);
          
          if (deviceRegistered) {
            console.log('Device successfully registered, attempting playback...');
            const success = await fetchAndPlayRandomLikedSong(spotifyDeviceId);
            if (!success && playbackAttempts < 2) {
              console.log('Initial playback failed, retrying in 5 seconds...');
              setTimeout(async () => {
                await fetchAndPlayRandomLikedSong(spotifyDeviceId);
              }, 5000);
            }
          } else {
            console.error('Device failed to register with Spotify backend');
            updateNowPlayingUI(null);
          }
        } catch (error) {
          console.error('Error during device initialization:', error);
        }
    });

    spotifyPlayer.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
        spotifyDeviceId = null;
        deviceReadyTimestamp = null;
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('initialization_error', ({ message }) => {
        console.error('Failed to initialize Spotify player:', message);
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('authentication_error', ({ message }) => {
        console.error('Spotify player authentication error:', message);
        if(spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
        localStorage.removeItem('spotify_access_token');
        localStorage.removeItem('spotify_token_expires_at');
        localStorage.removeItem('spotify_refresh_token');
        currentAccessToken = null;
        if (spotifyPlayer) { spotifyPlayer.disconnect(); }
        spotifyPlayer = null; 
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('account_error', ({ message }) => {
        console.error('Spotify player account error (e.g., no Premium?):', message);
        const artistNameEl = document.querySelector('.now-playing .artist-name');
        if(artistNameEl) artistNameEl.textContent = 'Spotify Premium required for playback.';
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('playback_error', ({ message }) => {
        console.error('Spotify player playback error:', message);
        updateNowPlayingUI(null);
    });

    spotifyPlayer.addListener('player_state_changed', (state) => {
        if (!state) {
            console.warn('Player state changed to null.');
            updateNowPlayingUI(null);
            return;
        }
        
        const currentTrack = state.track_window.current_track;
        updateNowPlayingUI(currentTrack);
        
        const timeCurrentEl = document.querySelector('.now-playing .time-elapsed');
        const formatTime = (ms) => {
            const minutes = Math.floor(ms / 60000);
            const seconds = ((ms % 60000) / 1000).toFixed(0);
            return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
        };
        if(timeCurrentEl) timeCurrentEl.textContent = formatTime(state.position);
        
        console.log(`Player state: ${state.paused ? 'paused' : 'playing'} at position ${formatTime(state.position)} - Track: ${currentTrack ? currentTrack.name : 'none'}`);
    });

    console.log('Connecting player...');
    spotifyPlayer.connect().then(success => {
        if (success) {
            console.log('The Web Playback SDK successfully connected to Spotify!');
        } else {
            console.error('The Web Playback SDK failed to connect to Spotify. Clearing player instance.');
            if (spotifyPlayer) { spotifyPlayer.disconnect(); }
            spotifyPlayer = null; 
        }
    }).catch(error => {
        console.error('Error on spotifyPlayer.connect():', error);
        if (spotifyPlayer) { spotifyPlayer.disconnect(); }
        spotifyPlayer = null; 
    });
  }

  function handleAuth() {
    const { accessToken, refreshToken, expiresIn, error } = parseHashParams();
    const authOverlayTitle = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('h2') : null;
    const authOverlayButton = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('button') : null;
    const authOverlayMessage = spotifyAuthOverlay ? spotifyAuthOverlay.querySelector('p') : null;

    if (error && authOverlayTitle && authOverlayButton && authOverlayMessage) {
      console.error('Spotify Auth Error from hash:', error);
      authOverlayTitle.textContent = 'Authentication Failed';
      authOverlayButton.textContent = 'TRY AGAIN';
      authOverlayMessage.textContent = `Error: ${error}. Please ensure permissions and try again.`;
      window.location.hash = '';
      if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex'; 
      return;
    }

    let tokenToUse = null;
    if (accessToken) {
      localStorage.setItem('spotify_access_token', accessToken);
      localStorage.setItem('spotify_token_expires_at', Date.now() + parseInt(expiresIn, 10) * 1000);
      if (refreshToken) {
        localStorage.setItem('spotify_refresh_token', refreshToken);
      }
      console.log('Token processed from URL hash.');
      tokenToUse = accessToken;
      window.location.hash = '';
    } else {
      const storedToken = localStorage.getItem('spotify_access_token');
      const tokenExpiresAt = localStorage.getItem('spotify_token_expires_at');
      if (storedToken && tokenExpiresAt && Date.now() < parseInt(tokenExpiresAt, 10)) {
        console.log('Using valid token from localStorage.');
        tokenToUse = storedToken;
      } else {
         console.log('No valid token in hash or storage. Auth needed.');
         if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'flex';
         localStorage.removeItem('spotify_access_token');
         localStorage.removeItem('spotify_token_expires_at');
         localStorage.removeItem('spotify_refresh_token');
         currentAccessToken = null;
         if(spotifyPlayer) { console.log('Disconnecting player due to no valid token.'); spotifyPlayer.disconnect(); spotifyPlayer = null; }
         return; 
      }
    }

    currentAccessToken = tokenToUse;
    if (spotifyAuthOverlay) spotifyAuthOverlay.style.display = 'none';
    console.log('Auth complete, token available. Current SDK ready status:', sdkReady);

    if (sdkReady) {
        if (!spotifyPlayer) {
            console.log('SDK is ready, initializing player now.');
            initializePlayerInternal(currentAccessToken);
        } else {
            console.log('SDK is ready, player already exists. Ensuring token is fresh for getOAuthToken.');
            // The getOAuthToken will use the updated currentAccessToken if needed.
        }
    } else {
        console.log('Token ready, but SDK not yet. onSpotifyWebPlaybackSDKReady will handle player init.');
    }
  }

  if (connectSpotifyBtn) {
    connectSpotifyBtn.addEventListener('click', () => {
      window.location.href = '/.netlify/functions/spotify-auth-login';
    });
  }

  // Handle authentication on page load
  handleAuth();

});
</script>

<!-- Global Playback Scrubber -->
<div class="fixed bottom-0 top-0 left-0 w-full opacity-10 pointer-events-none z-1">
  <div class="progressh-full bg-white transition-all" style="width: 20%;"></div>
</div>

<!-- Spotify Auth Overlay -->
<div id="spotify-auth-overlay" class="fixed inset-0 bg-emerald-950 bg-opacity-90 flex flex-col items-center justify-center z-50">
  <h2 class="special-gothic-condensed-one-regular text-4xl text-white mb-8">Connect to Spotify</h2>
  <button id="connect-spotify-btn" class="special-gothic-condensed-one-regular bg-green-500 hover:bg-green-400 text-white text-2xl py-4 px-8 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-green-300 focus:ring-opacity-50 transition duration-150 ease-in-out">
    TAP TO CONNECT SPOTIFY
  </button>
  <p class="text-emerald-300 text-sm mt-6 max-w-xs text-center">
    This app requires access to your Spotify account to play music and manage playback.
  </p>
</div>
</body>
</html> 